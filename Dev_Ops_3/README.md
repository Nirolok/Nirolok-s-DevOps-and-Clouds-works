# Очень плохой CI/CD файл
Для начала рассмотрим плохой CI/CD файл.
## Пример плохого CI/CD файла в формате yaml
```
# 1. Остутсвие кэширования зависимостей. На каждом запуске пайплайна зависимости будут устанавливаться заново
stages:
  - install
  - test
  - deploy

install_dependencies:
  stage: install
  script:
    - npm install  # Нет использования кэша node_modules 

#2. Запуск всех этапов без учёта изменений. Этапы запускаются независимо от того, какие файлы были изменены
run_tests:
  stage: test
  script:
    - npm test
    - npm run lint  # Тесты и линтеры запускаются без учёта зависимости изменения

#3. Деплой может произойти в обход линтеров и тестов. Развертывание происходит без выполнения линтинга и тестирования
deploy_to_production:
  stage: deploy
  script:
    - ./deploy.sh  #Не проверяется успешность выполнения тестов перед деплоем

#4. "Несекретные секреты". Секретные данные хранятся прямо в CI/CD файле
deploy_to_production:
  stage: deploy
  script:
    - export SUPER_SECRET_SECRET=browser_history  # Секрет задан в явном виде и не использует защищённые переменные
    - ./deploy.sh

# 5. Непродуманная система исходов. В случае ошибки при развёртывании не предусмотрен откат
deploy_to_production:
  stage: deploy
  script:
    - ./deploy.sh  # Нет механизмов, которые могли бы сделать откат в случае возникновения ошибки
```
Теперь давайте разбираться, что здесь не так и почему.

## 1. Отсутствие кэширования зависимостей
На этапе установки зависимостей (`install_dependencies`) не используется кэш для установки зависимостей, что увеличивает время необходимое на сборку.
```
install_dependencies:
  stage: install
  script:
    - npm install  # Ошибка: нет использования кэша для node_modules
```
Для решения данной проблемы следует использовать `npm install`

## 2. Запуск всех этапов без учёта изменений
На этапе тестов (`run_test`) все тесты и линтеры запускаются вне зависимости от вида изменения и файлов, которые они затрагивают. Это значительно увеличает время сборки и может вызывать излишнюю нагрузку на систему.
```
run_tests:
  stage: test
  script:
    - npm test
    - npm run lint
```
Для устранения данной ошибки стоит добавить конструкцию:
```
 only:
    changes:
      - src/*
```
В таком случае тесты и линтеры будут выполнятся, только при изменении файлов в директории src/

## 3. Деплой может произойти в обход линтеров и тестов
На этапе развёртки (`deploy_to_production`) деплой может произойти в обход тетстов и линтеров, что может привести к развёртыванию нерабочего кода.
```
deploy_to_production:
  stage: deploy
  script:
    - ./deploy.sh
```
Для того чтобы деплой происходил только после прохождения полного цикла тестов, необходимо добавить конструкцию:
```
needs:
    - run_tests 
```
Это обозначит зависимость между деплоем и прохождением тестов


## 4. "Несекретные секреты"
На этапе развёртывания секрет записывается в явном виде, что может привести к утечкам и всеми связанными с этим проблемами.
```
deploy_to_production:
  stage: deploy
  script:
    - export SUPER_SECRET_SECRET=bnrowser_history 
    - ./deploy.sh
```
Для улучшения безопастности следует использовать защищённые переменные среды, например:

```
 - export SUPER_SECRET_SECRET=$SUPER_SECRET_SECRET
```

## 5.  Непродуманная система исходов
В данном случае, на этапе развёртывания может произойти сбой, если развёртывание прошло некоректно.
```
deploy_to_production:
  stage: deploy
  script:
    - ./deploy.sh
```
Для того чтобы система не ложилась из-за проблем с развёртыванием, стоит запусткать скрипт отката развёртывание после возникновения ошибки:

```
deploy_to_production:
  stage: deploy
  script:
    - ./deploy.sh || ./backflip.sh
```
# Хороший добрый CI/CD файл

## Пример хорошего CI/CD файла в формате yaml

```
stages:
  - install
  - test
  - deploy

# 1. Добавили кэширование зависимостей. Теперь кэшируем папку node_modules, чтобы ускорить установку зависимостей
install_dependencies:
  stage: install
  cache:
    paths:
      - node_modules/  # Вот здесь и кэшируем
  script:
    - npm install


# 2. Добавили зависимость запуска тестов от измения файлов в директории src/
run_tests:
  stage: test
  script:
    - npm test
    - npm run lint
  only:
    changes:
      - src/*  # Цикл тестов будет запускаться только при изменении файлов в директории src/

# 3. Добавили проверку успешности прохождения тестов перед деплоем
deploy_to_production:
  stage: deploy
  script:
    - ./deploy.sh
  needs:
    - run_tests  # Развёртывание требует успешного прохождения всех тестов


# 4. Секрет не хранится в явном виде и хранится в защищённой переменной
deploy_to_production:
  stage: deploy
  script:
    - export SUPER_SECRET_SECRET=$SUPER_SECRET_SECRET  # Используем защищённую переменную
    - ./deploy.sh


# 5. При возникновении ошибки развёртывания запускается скрипт отката
deploy_to_production:
  stage: deploy
  script:
    - ./deploy.sh || ./backflip.sh  # Откат при неудаче
```

В данном примере прописаны все вышуказанные альтернативы "плохим практикам"







